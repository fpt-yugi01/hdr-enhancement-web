{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8" x-data="hdrApp()">
    <!-- Statistics Cards -->
    <div class="grid md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="bg-blue-500 rounded-full p-3">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Tasks</p>
                    <p class="text-2xl font-bold text-gray-900">{{ total_tasks }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="bg-green-500 rounded-full p-3">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Completed</p>
                    <p class="text-2xl font-bold text-gray-900">{{ completed_tasks }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="bg-yellow-500 rounded-full p-3">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Processing</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="processingCount">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-900 mb-6">Upload Image for HDR Enhancement</h2>
        
        <div class="upload-area p-8 rounded-lg text-center" 
             x-bind:class="{'drag-over': isDragging}"
             x-on:dragover.prevent="isDragging = true"
             x-on:dragleave.prevent="isDragging = false"
             x-on:drop.prevent="handleDrop($event)">
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <p class="text-lg text-gray-600 mb-2">Drag and drop your image here, or</p>
            <input type="file" id="imageInput" accept="image/*" x-on:change="handleFileSelect($event)" class="hidden">
            <button x-on:click="$('#imageInput').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">
                Choose File
            </button>
            <p class="text-sm text-gray-500 mt-2">Supported formats: JPEG, PNG, TIFF (Max: 50MB)</p>
        </div>
        
        <!-- Upload Progress -->
        <div x-show="uploading" class="mt-6">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-600">Uploading...</span>
                <span class="text-sm text-gray-600" x-text="uploadProgress + '%'"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full progress-bar" x-bind:style="'width: ' + uploadProgress + '%'"></div>
            </div>
        </div>
    </div>

    <!-- Recent Tasks -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-900">Recent Tasks</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="task in tasks" :key="task.id">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-gray-900" x-text="task.original_filename"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                      x-bind:class="getStatusClass(task.status)"
                                      x-text="task.status"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" 
                                         x-bind:style="'width: ' + task.progress + '%'"></div>
                                </div>
                                <span class="text-xs text-gray-600" x-text="task.progress + '%'"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(task.created_at)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button x-show="task.status === 'completed'" 
                                        x-on:click="downloadResult(task.id)"
                                        class="text-green-600 hover:text-green-900 mr-3">
                                    Download
                                </button>
                                <button x-on:click="refreshTask(task.id)" class="text-blue-600 hover:text-blue-900">
                                    Refresh
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function hdrApp() {
    return {
        tasks: {{ recent_tasks|safe }},
        uploading: false,
        uploadProgress: 0,
        isDragging: false,
        processingCount: 0,
        
        init() {
            this.loadTasks();
            this.startPolling();
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.uploadFile(file);
            }
        },
        
        handleDrop(event) {
            this.isDragging = false;
            const file = event.dataTransfer.files[0];
            if (file) {
                this.uploadFile(file);
            }
        },
        
        uploadFile(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            this.uploading = true;
            this.uploadProgress = 0;
            
            fetch('/api/upload/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': this.getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                this.uploading = false;
                if (data.task_id) {
                    this.loadTasks();
                    alert('Upload successful! Processing started.');
                } else {
                    alert('Upload failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                this.uploading = false;
                alert('Upload failed: ' + error.message);
            });
        },
        
        loadTasks() {
            fetch('/api/history/')
            .then(response => response.json())
            .then(data => {
                this.tasks = data.tasks || [];
                this.processingCount = this.tasks.filter(t => t.status === 'processing' || t.status === 'pending').length;
            });
        },
        
        refreshTask(taskId) {
            fetch(`/api/status/${taskId}/`)
            .then(response => response.json())
            .then(data => {
                const index = this.tasks.findIndex(t => t.id === taskId);
                if (index !== -1) {
                    this.tasks[index] = data;
                }
            });
        },
        
        downloadResult(taskId) {
            window.location.href = `/api/result/${taskId}/`;
        },
        
        startPolling() {
            setInterval(() => {
                if (this.processingCount > 0) {
                    this.loadTasks();
                }
            }, 5000);
        },
        
        getStatusClass(status) {
            const classes = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'processing': 'bg-blue-100 text-blue-800',
                'completed': 'bg-green-100 text-green-800',
                'failed': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        },
        
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        },
        
        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
    }
}
</script>

{% csrf_token %}
{% endblock %}